<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Compras e Vendas - Minecraft Style</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Press Start 2P', cursive;
      background-color: #000;
      background-size: 64px;
      color: #fff;
    }

    .container {
      width: 100%;
      height: 100%;
      padding: 30px;
      background: rgba(0, 0, 0, 0.85);
      box-sizing: border-box;
      border: 4px solid #3e3e3e;
    }

    h2 {
      color: #8fff5f;
      text-align: center;
      text-shadow: 2px 2px #000;
      margin-bottom: 30px;
    }

    input, select, button {
      font-family: 'Press Start 2P', monospace;
      padding: 10px;
      margin: 5px;
      font-size: 12px;
      border-radius: 0;
      border: 3px solid #000;
      background: #c2b280;
      color: #000;
      box-shadow: 2px 2px #1f1f1f;
    }

    select option { background-color: #c2b280; color: #000; }

    button { cursor: pointer; transition: 0.2s; }

    .btn-add { background: #00aa00; color: #fff; }
    .btn-edit { background: #ffaa00; color: #000; }
    .btn-save { background: #0099ff; color: #fff; }
    .btn-delete { background: #cc0000; color: #fff; }
    .btn-lucro {
      background: #6a5acd; color: #fff; margin-top: 10px; float: right; box-shadow: 0 0 10px #6a5acd;
    }
    .btn-add:hover, .btn-edit:hover, .btn-save:hover, .btn-delete:hover, .btn-lucro:hover {
      transform: scale(1.05); filter: brightness(1.1);
    }

    .toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background-color: #5c5c5c;
    }

    thead { background: #006400; color: #fff; }

    th, td { padding: 10px; border: 2px solid #000; text-align: center; }

    .lucro { margin-top: 15px; font-weight: bold; color: #8fff5f; text-align: right; text-shadow: 1px 1px #000; }

    input[type="radio"] { transform: scale(1.2); margin-right: 5px; }

    ::placeholder { color: #333; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚õè Controle de Compras e Vendas</h2>

    <!-- Formul√°rio de cadastro -->
    <div class="toolbar">
      <input id="nome" placeholder="Nome do item" />
      <input id="compra" type="text" placeholder="Valor compra" />
      <input id="venda" type="text" placeholder="Valor venda (opcional)" />
      <input id="dataCompra" type="date" />
      <input id="dataVenda" type="date" />
      <select id="categoria">
        <option value="">Categoria</option>
        <option>Fonte</option>
        <option>SSD</option>
        <option>HD</option>
        <option>Mem√≥ria RAM</option>
        <option>Placa-m√£e</option>
        <option>Processador</option>
        <option>Placa de V√≠deo</option>
        <option>Cooler</option>
        <option>Gabinete</option>
        <option>Teclado</option>
        <option>Mouse</option>
        <option>Monitor</option>
        <option>Cabo</option>
        <option>Head-set</option>
        <option>Outros</option>
      </select>
      <button class="btn-add" onclick="adicionar()">‚ûï Adicionar</button>
      <a href="lucro.html"><button class="btn-lucro">üìä Ver Lucro Mensal</button></a>
      <a href="comparativo.html"><button class="btn-lucro" style="background:#25e00c; box-shadow:0 0 10px #09e61c;">üìà Comparar KAYN x ANTONIO PEDRO</button></a>
    </div>

    <!-- Filtros e ordena√ß√£o -->
    <div class="toolbar" style="margin-top: 14px;">
      <label><input type="radio" name="filtro" value="todos" checked onchange="mostrar()" /> Todos</label>
      <label><input type="radio" name="filtro" value="vendidos" onchange="mostrar()" /> Vendidos</label>
      <label><input type="radio" name="filtro" value="naoVendidos" onchange="mostrar()" /> N√£o Vendidos</label>

      <!-- Busca r√°pida (nome/categoria) -->
      <input type="text" id="buscaTexto" placeholder="üîç Buscar por nome ou categoria" oninput="mostrar()" style="flex:1; min-width:240px;" />

      <!-- Filtro por categoria (sele√ß√£o) -->
      <select id="filtroCategoria" onchange="mostrar()">
        <option value="">Todas as categorias</option>
      </select>

      <!-- Ordena√ß√£o (apenas por campo, dire√ß√£o sempre crescente) -->
      <select id="ordenarPor" onchange="mostrar()">
        <option value="nome">Ordenar por: Nome</option>
        <option value="categoria">Categoria</option>
        <option value="dataCompra">Data de Compra</option>
        <option value="dataVenda">Data de Venda</option>
        <option value="compra">Valor de Compra</option>
        <option value="venda">Valor de Venda</option>
        <option value="lucro">Lucro</option>
      </select>
      <!-- Select de dire√ß√£o REMOVIDO -->
    </div>

    <div class="lucro" id="lucroTotal">üíé Lucro total: R$ 0,00</div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Compra</th>
          <th>Venda</th>
          <th>Lucro</th>
          <th>Data Compra</th>
          <th>Data Venda</th>
          <th>Categoria</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyGbrlrxWmcNj9Tm2ZWWa7gvvoil4lyrI",
      authDomain: "joabe-anotacoes.firebaseapp.com",
      projectId: "joabe-anotacoes",
      storageBucket: "joabe-anotacoes.appspot.com",
      messagingSenderId: "50670952443",
      appId: "1:50670952443:web:67880481e8aadec981355e",
      measurementId: "G-E68TLB4Z1G"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const col = collection(db, "itens");

    // ===== Helpers de Data/Moeda =====
    function dateAtNoon(y, m, d) { return new Date(y, m - 1, d, 12, 0, 0, 0); }
    function formatBR(date) { return date ? date.toLocaleDateString('pt-BR') : ''; }
    function formatBRFromStored(stored) {
      if (!stored) return '';
      const d = stored?.seconds ? new Date(stored.seconds * 1000) : new Date(stored);
      return formatBR(d);
    }
    function toDateFromInput(value) {
      if (!value) return null; const [y, m, d] = value.split('-').map(Number); return dateAtNoon(y, m, d);
    }
    function parseBRDate(str) {
      if (!str) return null; const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if (!m) return null; const d = Number(m[1]), mo = Number(m[2]), y = Number(m[3]); return dateAtNoon(y, mo, d);
    }
    function parseMoney(str) {
      if (str == null) return NaN; let s = String(str).replace(/R\$\s?/i, '').trim(); s = s.replace(/\./g, '').replace(',', '.'); const n = parseFloat(s); return Number.isFinite(n) ? n : NaN;
    }
    const brl = (n) => Number.isFinite(n) ? n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '';

    function todayInputValue() {
      const t = new Date(); const y = t.getFullYear(); const m = String(t.getMonth() + 1).padStart(2, '0'); const d = String(t.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`;
    }
    const dcEl = document.getElementById('dataCompra'); if (dcEl && !dcEl.value) dcEl.value = todayInputValue();

    // ===== CRUD =====
    async function adicionar() {
      const nome = document.getElementById('nome').value.trim();
      const compra = parseMoney(document.getElementById('compra').value);
      const vendaInput = document.getElementById('venda').value; const venda = vendaInput !== '' ? parseMoney(vendaInput) : null;
      const dataCompra = toDateFromInput(document.getElementById('dataCompra').value);
      const dataVenda = toDateFromInput(document.getElementById('dataVenda').value);
      const categoria = document.getElementById('categoria').value.trim();

      if (!nome || !categoria) { alert('Preencha os campos obrigat√≥rios (nome e categoria).'); return; }
      if (!Number.isFinite(compra) || compra < 0) { alert('Valor de compra inv√°lido (aceita 0 ou positivo).'); return; }
      if (venda !== null && (!Number.isFinite(venda) || venda < 0)) { alert('Valor de venda inv√°lido.'); return; }

      await addDoc(col, { nome, compra, venda, dataCompra, dataVenda, categoria });
      limpar(); await mostrar();
    }

    async function excluir(id) { await deleteDoc(doc(db, 'itens', id)); await mostrar(); }

    function editar(id) {
      const linha = document.getElementById(`linha-${id}`);
      const cels = linha.querySelectorAll('td');
      for (let i = 0; i < 7; i++) cels[i].setAttribute('contenteditable', 'true');
      linha.querySelector('.btn-edit').style.display = 'none';
      linha.querySelector('.btn-save').style.display = 'inline-block';
    }

    async function salvar(id) {
      const linha = document.getElementById(`linha-${id}`);
      const cels = linha.querySelectorAll('td');
      const nome = cels[0].innerText.trim();
      const compra = parseMoney(cels[1].innerText);
      const venda = cels[2].innerText.trim() !== '' ? parseMoney(cels[2].innerText) : null;
      const dataCompra = parseBRDate(cels[4].innerText) ?? toDateFromInput(cels[4].innerText) ?? null;
      const dataVenda = parseBRDate(cels[5].innerText) ?? toDateFromInput(cels[5].innerText) ?? null;
      const categoria = cels[6].innerText.trim();

      if (!nome || !categoria) { alert('Preencha os campos obrigat√≥rios (nome e categoria).'); return; }
      if (!Number.isFinite(compra) || compra < 0) { alert('Valor de compra inv√°lido (aceita 0 ou positivo).'); return; }
      if (venda !== null && (!Number.isFinite(venda) || venda < 0)) { alert('Valor de venda inv√°lido.'); return; }

      await updateDoc(doc(db, 'itens', id), { nome, compra, venda, dataCompra, dataVenda, categoria });

      // ‚úÖ corrigido: sem par√™ntese extra
      for (let i = 0; i < 7; i++) cels[i].setAttribute('contenteditable', 'false');

      linha.querySelector('.btn-edit').style.display = 'inline-block';
      linha.querySelector('.btn-save').style.display = 'none';
      await mostrar();
    }

    function limpar() {
      document.getElementById('nome').value = '';
      document.getElementById('compra').value = '';
      document.getElementById('venda').value = '';
      document.getElementById('dataCompra').value = todayInputValue();
      document.getElementById('dataVenda').value = '';
      document.getElementById('categoria').value = '';
    }

    function detalhes(id) { window.location.href = `detalhes.html?id=${id}`; }

    // ===== Util: normaliza√ß√£o para ordena√ß√£o =====
    function toMillis(v) {
      if (!v) return 0;
      const d = v?.seconds ? new Date(v.seconds * 1000) : new Date(v);
      return d instanceof Date && !isNaN(d) ? d.getTime() : 0;
    }

    function cmp(a, b) { return a < b ? -1 : a > b ? 1 : 0; }

    // Ordena√ß√£o sempre CRESCENTE
    function sortItems(items, key) {
      return items.sort((A, B) => {
        let va, vb;
        switch (key) {
          case 'nome':
            va = (A.nome||'').toString().toLowerCase(); vb = (B.nome||'').toString().toLowerCase();
            break;
          case 'categoria':
            va = (A.categoria||'').toString().toLowerCase(); vb = (B.categoria||'').toString().toLowerCase();
            break;
          case 'compra': va = Number(A.compra)||0; vb = Number(B.compra)||0; break;
          case 'venda': va = (A.venda==null? -Infinity : Number(A.venda)); vb = (B.venda==null? -Infinity : Number(B.venda)); break;
          case 'lucro':
            va = (A.venda==null? -Infinity : Number(A.venda) - Number(A.compra||0));
            vb = (B.venda==null? -Infinity : Number(B.venda) - Number(B.compra||0));
            break;
          case 'dataCompra': va = toMillis(A.dataCompra); vb = toMillis(B.dataCompra); break;
          case 'dataVenda': va = toMillis(A.dataVenda); vb = toMillis(B.dataVenda); break;
          default: va = 0; vb = 0;
        }
        return cmp(va, vb); // sempre crescente
      });
    }

    // ===== Render principal =====
    async function mostrar() {
      const filtro = document.querySelector('input[name="filtro"]:checked').value;
      const buscaTexto = document.getElementById('buscaTexto').value.toLowerCase();
      const filtroCategoria = document.getElementById('filtroCategoria').value;
      const ordenarPor = document.getElementById('ordenarPor').value;
      const tabela = document.getElementById('tabela');
      tabela.innerHTML = '';

      const snap = await getDocs(col);
      /** @type {{id:string, nome:string, compra:number, venda:number|null, dataCompra:any, dataVenda:any, categoria:string}[]} */
      let items = [];
      snap.forEach(d => items.push({ id: d.id, ...d.data() }));

      // popular seletor de categorias (√∫nicas)
      const sel = document.getElementById('filtroCategoria');
      const existentes = new Set(['']);
      items.forEach(x => { if (x.categoria) existentes.add(x.categoria); });
      if (sel.options.length !== existentes.size) {
        const atual = sel.value;
        sel.innerHTML = '<option value="">Todas as categorias</option>' +
          Array.from(existentes).filter(v=>v).sort((a,b)=>a.localeCompare(b,'pt-BR')).map(c=>`<option>${c}</option>`).join('');
        if ([...existentes].includes(atual)) sel.value = atual;
      }

      // filtros
      items = items.filter(it => {
        const vendido = it.venda !== null && it.venda !== undefined;
        if ((filtro === 'vendidos' && !vendido) || (filtro === 'naoVendidos' && vendido)) return false;
        if (filtroCategoria && it.categoria !== filtroCategoria) return false;
        if (buscaTexto) {
          const nome = (it.nome||'').toLowerCase();
          const cat = (it.categoria||'').toLowerCase();
          if (!nome.includes(buscaTexto) && !cat.includes(buscaTexto)) return false;
        }
        return true;
      });

      // ordena√ß√£o (sempre crescente)
      items = sortItems(items, ordenarPor);

      // render + lucro total sobre os itens exibidos e vendidos
      let lucroTotal = 0;
      for (const item of items) {
        const vendido = item.venda !== null && item.venda !== undefined;
        const lucro = vendido ? (Number(item.venda) - Number(item.compra||0)) : null;
        if (vendido && Number.isFinite(lucro)) lucroTotal += lucro;

        tabela.insertAdjacentHTML('beforeend', `
          <tr id="linha-${item.id}">
            <td contenteditable="false">${item.nome ?? ''}</td>
            <td contenteditable="false">${brl(item.compra)}</td>
            <td contenteditable="false">${item.venda != null ? brl(item.venda) : ''}</td>
            <td>${vendido ? brl(lucro) : '-'}</td>
            <td contenteditable="false">${formatBRFromStored(item.dataCompra)}</td>
            <td contenteditable="false">${formatBRFromStored(item.dataVenda)}</td>
            <td contenteditable="false">${item.categoria ?? ''}</td>
            <td>
              <button class="btn-edit" onclick="editar('${item.id}')">‚úèÔ∏è</button>
              <button class="btn-save" onclick="salvar('${item.id}')" style="display:none;">üìÇ</button>
              <button class="btn-delete" onclick="excluir('${item.id}')">üóëÔ∏è</button>
              <button onclick="detalhes('${item.id}')">üîç</button>
            </td>
          </tr>
        `);
      }

      document.getElementById('lucroTotal').innerText = `üíé Lucro total: ${brl(lucroTotal)}`;
    }

    // Expor para os bot√µes
    window.adicionar = adicionar;
    window.mostrar = mostrar;
    window.excluir = excluir;
    window.editar = editar;
    window.salvar = salvar;
    window.detalhes = detalhes;

    // primeira carga
    mostrar();
  </script>
</body>
</html>
