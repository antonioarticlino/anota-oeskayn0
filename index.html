<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Compras e Vendas - Minecraft Style</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      font-family: 'Press Start 2P', cursive; background-color: #000; color: #fff;
    }
    .container {
      width: 100%; height: 100%; padding: 30px; box-sizing: border-box;
      background: rgba(0,0,0,.85); border: 4px solid #3e3e3e;
    }
    h2 { color:#8fff5f; text-align:center; text-shadow:2px 2px #000; margin-bottom:30px; }
    input, select, button {
      font-family:'Press Start 2P', monospace; padding:10px; margin:5px; font-size:12px;
      border-radius:0; border:3px solid #000; background:#c2b280; color:#000; box-shadow:2px 2px #1f1f1f;
    }
    select option { background:#c2b280; color:#000; }
    button { cursor:pointer; transition:.2s; }
    .btn-add{ background:#00aa00; color:#fff; }
    .btn-edit{ background:#ffaa00; color:#000; }
    .btn-save{ background:#0099ff; color:#fff; }
    .btn-delete{ background:#cc0000; color:#fff; }
    .btn-lucro{ background:#6a5acd; color:#fff; margin-top:10px; float:right; box-shadow:0 0 10px #6a5acd; }
    .btn-add:hover,.btn-edit:hover,.btn-save:hover,.btn-delete:hover,.btn-lucro:hover{ transform:scale(1.05); filter:brightness(1.1); }

    table{ width:100%; margin-top:20px; border-collapse:collapse; background:#5c5c5c; }
    thead{ background:#006400; color:#fff; }
    th,td{ padding:10px; border:2px solid #000; text-align:center; }

    .lucro{ margin-top:15px; font-weight:bold; color:#8fff5f; text-align:right; text-shadow:1px 1px #000; }
    input[type="radio"]{ transform:scale(1.2); margin-right:5px; }
    ::placeholder{ color:#333; }

    /* Pagina√ß√£o */
    .pagination-bar{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      margin-top:16px; background:#3b3b3b; border:3px solid #000; padding:10px;
    }
    .pagination-controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .page-btn{
      background:#2e7d32; color:#fff; border:3px solid #000; box-shadow:2px 2px #1f1f1f; padding:8px 10px;
    }
    .page-btn[disabled]{ opacity:.6; filter:grayscale(.4); cursor:not-allowed; }
    .page-info{ color:#8fff5f; text-shadow:1px 1px #000; font-size:12px; }
    .page-size{ background:#c2b280; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚õè Controle de Compras e Vendas</h2>

    <div>
      <input id="nome" placeholder="Nome do item">
      <input id="compra" type="number" step="0.01" placeholder="Valor compra">
      <input id="venda" type="number" step="0.01" placeholder="Valor venda (opcional)">
      <input id="dataCompra" type="date">
      <input id="dataVenda" type="date">
      <select id="categoria">
        <option value="">Categoria</option>
        <option>Fonte</option><option>SSD</option><option>HD</option><option>Mem√≥ria RAM</option>
        <option>Placa-m√£e</option><option>Processador</option><option>Placa de V√≠deo</option>
        <option>Cooler</option><option>Gabinete</option><option>Teclado</option><option>Mouse</option>
        <option>Monitor</option><option>Cabo</option><option>Head-set</option><option>Outros</option>
      </select>
      <button class="btn-add" onclick="adicionar()">‚ûï Adicionar</button>
      <a href="lucro.html"><button class="btn-lucro">üìä Ver Lucro Mensal</button></a>
      <a href="comparativo.html">
        <button class="btn-lucro" style="background:#25e00c; box-shadow:0 0 10px #09e61c;">üìà Comparar KAYN x ANTONIO PEDRO</button>
      </a>
    </div>

    <div style="margin-top:20px;">
      <label><input type="radio" name="filtro" value="todos" checked onchange="aplicarFiltros()"> Todos</label>
      <label><input type="radio" name="filtro" value="vendidos" onchange="aplicarFiltros()"> Vendidos</label>
      <label><input type="radio" name="filtro" value="naoVendidos" onchange="aplicarFiltros()"> N√£o Vendidos</label>
    </div>

    <div>
      <input type="text" id="buscaCategoria" placeholder="üîç Buscar" oninput="aplicarFiltros()">
    </div>

    <div class="lucro" id="lucroTotal">üíé Lucro (p√°gina): R$ 0,00</div>

    <table>
      <thead>
        <tr>
          <th>Nome</th><th>Compra</th><th>Venda</th><th>Lucro</th>
          <th>Data Compra</th><th>Data Venda</th><th>Categoria</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>

    <!-- Barra de Pagina√ß√£o -->
    <div class="pagination-bar">
      <div class="pagination-controls">
        <button class="page-btn" id="firstPage" onclick="irPrimeira()">‚èÆ Primeira</button>
        <button class="page-btn" id="prevPage"  onclick="irAnterior()">‚óÄ Anterior</button>
        <span class="page-info" id="pageInfo">P√°gina 1 de 1 ‚Ä¢ 0 itens</span>
        <button class="page-btn" id="nextPage"  onclick="irProxima()">Pr√≥xima ‚ñ∂</button>
        <button class="page-btn" id="lastPage"  onclick="irUltima()">‚è≠ √öltima</button>
      </div>
      <div class="pagination-controls">
        <label for="pageSize">Itens por p√°gina:</label>
        <select id="pageSize" class="page-size" onchange="mudarPageSize()">
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    // === Firebase do teu projeto ===
    const firebaseConfig = {
      apiKey: "AIzaSyDyGbrlrxWmcNj9Tm2ZWWa7gvvoil4lyrI",
      authDomain: "joabe-anotacoes.firebaseapp.com",
      projectId: "joabe-anotacoes",
      storageBucket: "joabe-anotacoes.appspot.com",
      messagingSenderId: "50670952443",
      appId: "1:50670952443:web:67880481e8aadec981355e",
      measurementId: "G-E68TLB4Z1G"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const col = collection(db, "itens");

    // ===== Utils =====
    const brl = (n) => Number.isFinite(n) ? n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '';
    const fmtData = (x) => x ? new Date(x.seconds ? x.seconds*1000 : x).toLocaleDateString('pt-BR') : "";

    // ===== Estado (cache + pagina√ß√£o) =====
    let itensCache = [];      // [{id, data}]
    let itensFiltrados = [];  // ap√≥s filtros
    let currentPage = 1;
    let pageSize   = 10;

    // ===== CRUD =====
    async function adicionar(){
      const nome = document.getElementById('nome').value.trim();
      const compra = parseFloat(document.getElementById('compra').value);
      const vendaInput = document.getElementById('venda').value;
      const venda = vendaInput ? parseFloat(vendaInput) : null;
      const dataCompraStr = document.getElementById('dataCompra').value;
      const dataVendaStr  = document.getElementById('dataVenda').value;
      const dataCompra = dataCompraStr ? new Date(dataCompraStr) : null;
      const dataVenda  = dataVendaStr  ? new Date(dataVendaStr)  : null;
      const categoria  = document.getElementById('categoria').value;

      if (!nome || !Number.isFinite(compra) || !categoria) { alert("Preencha nome, compra e categoria."); return; }
      await addDoc(col, { nome, compra, venda, dataCompra, dataVenda, categoria });
      limpar();
      await carregarTudo();
      aplicarFiltros();
    }

    async function excluir(id){
      await deleteDoc(doc(db,"itens",id));
      await carregarTudo();
      aplicarFiltros();
    }

    function editar(id){
      const linha = document.getElementById(`linha-${id}`);
      const cels = linha.querySelectorAll("td");
      for(let i=0;i<7;i++) cels[i].setAttribute("contenteditable","true");
      linha.querySelector(".btn-edit").style.display="none";
      linha.querySelector(".btn-save").style.display="inline-block";
    }

    async function salvar(id){
      const linha = document.getElementById(`linha-${id}`);
      const cels  = linha.querySelectorAll("td");
      const nome  = cels[0].innerText.trim();
      const compra= parseFloat(cels[1].innerText);
      const venda = cels[2].innerText.trim()? parseFloat(cels[2].innerText): null;
      const dataCompraStr = cels[4].innerText.trim();
      const dataVendaStr  = cels[5].innerText.trim();
      const dataCompra = dataCompraStr? new Date(dataCompraStr): null;
      const dataVenda  = dataVendaStr ? new Date(dataVendaStr) : null;
      const categoria  = cels[6].innerText.trim();

      if (!nome || !Number.isFinite(compra) || !categoria) { alert("Preencha nome, compra e categoria."); return; }
      await updateDoc(doc(db,"itens",id), { nome, compra, venda, dataCompra, dataVenda, categoria });

      for(let i=0;i<7;i++) cels[i].setAttribute("contenteditable","false");
      linha.querySelector(".btn-edit").style.display="inline-block";
      linha.querySelector(".btn-save").style.display="none";

      await carregarTudo();
      aplicarFiltros();
    }

    function limpar(){
      document.getElementById('nome').value="";
      document.getElementById('compra').value="";
      document.getElementById('venda').value="";
      document.getElementById('dataCompra').value="";
      document.getElementById('dataVenda').value="";
      document.getElementById('categoria').value="";
    }

    function detalhes(id){ window.location.href = `detalhes.html?id=${id}`; }

    // ===== Filtros + Render com pagina√ß√£o =====
    function aplicarFiltros(){
      const filtro = document.querySelector('input[name="filtro"]:checked').value;
      const termo  = (document.getElementById('buscaCategoria')?.value || "").toLowerCase();

      itensFiltrados = itensCache.filter(({data})=>{
        const vendido = data.venda !== null && data.venda !== undefined;
        if (filtro==='vendidos' && !vendido) return false;
        if (filtro==='naoVendidos' && vendido) return false;
        if (termo && !(data.categoria||'').toLowerCase().includes(termo)) return false;
        return true;
      });

      currentPage = 1; // reset ao mudar filtros/busca
      renderTabelaPaginada();
    }

    function renderTabelaPaginada(){
      const tbody = document.getElementById('tabela');
      tbody.innerHTML = "";

      const total = itensFiltrados.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage-1)*pageSize;
      const end   = start + pageSize;
      const pagina = itensFiltrados.slice(start, end);

      let lucroPagina = 0;

      for (const {id, data} of pagina){
        const vendido = data.venda !== null && data.venda !== undefined;
        const lucro   = vendido ? (data.venda - data.compra) : null;
        if (vendido) lucroPagina += (data.venda - data.compra);

        tbody.innerHTML += `
          <tr id="linha-${id}">
            <td contenteditable="false">${data.nome||""}</td>
            <td contenteditable="false">${brl(data.compra)}</td>
            <td contenteditable="false">${data.venda!=null? brl(data.venda): ""}</td>
            <td>${vendido? brl(lucro): "-"}</td>
            <td contenteditable="false">${fmtData(data.dataCompra)}</td>
            <td contenteditable="false">${fmtData(data.dataVenda)}</td>
            <td contenteditable="false">${data.categoria||""}</td>
            <td>
              <button class="btn-edit" onclick="editar('${id}')">‚úèÔ∏è</button>
              <button class="btn-save" onclick="salvar('${id}')" style="display:none;">üìÇ</button>
              <button class="btn-delete" onclick="excluir('${id}')">üóëÔ∏è</button>
              <button onclick="detalhes('${id}')">üîç</button>
            </td>
          </tr>
        `;
      }

      document.getElementById('lucroTotal').innerText = `üíé Lucro (p√°gina): ${brl(lucroPagina)}`;
      atualizarControlesPaginacao(currentPage, totalPages, total);
    }

    function atualizarControlesPaginacao(page, totalPages, totalItems){
      document.getElementById('pageInfo').textContent = `P√°gina ${page} de ${totalPages} ‚Ä¢ ${totalItems} itens`;
      document.getElementById('firstPage').disabled = page<=1;
      document.getElementById('prevPage').disabled  = page<=1;
      document.getElementById('nextPage').disabled  = page>=totalPages;
      document.getElementById('lastPage').disabled  = page>=totalPages;
    }

    // Navega√ß√£o
    function irPrimeira(){ currentPage = 1; renderTabelaPaginada(); }
    function irAnterior(){ if(currentPage>1){ currentPage--; renderTabelaPaginada(); } }
    function irProxima(){ const tp = Math.max(1, Math.ceil(itensFiltrados.length/pageSize)); if(currentPage<tp){ currentPage++; renderTabelaPaginada(); } }
    function irUltima(){ currentPage = Math.max(1, Math.ceil(itensFiltrados.length/pageSize)); renderTabelaPaginada(); }
    function mudarPageSize(){
      const sel = document.getElementById('pageSize');
      pageSize = parseInt(sel.value,10)||10;
      currentPage = 1;
      renderTabelaPaginada();
    }

    // ===== Load =====
    async function carregarTudo(){
      const snap = await getDocs(col);
      itensCache = [];
      snap.forEach(d => itensCache.push({ id:d.id, data:d.data() }));
      // Ordena por dataCompra desc, depois nome
      itensCache.sort((a,b)=>{
        const ad = a.data.dataCompra ? (a.data.dataCompra.seconds ? a.data.dataCompra.seconds*1000 : +new Date(a.data.dataCompra)) : 0;
        const bd = b.data.dataCompra ? (b.data.dataCompra.seconds ? b.data.dataCompra.seconds*1000 : +new Date(b.data.dataCompra)) : 0;
        if (bd!==ad) return bd-ad;
        return (a.data.nome||'').localeCompare(b.data.nome||'');
      });
    }

    // Expor globais usadas no HTML
    window.adicionar = adicionar;
    window.excluir   = excluir;
    window.editar    = editar;
    window.salvar    = salvar;
    window.detalhes  = detalhes;

    window.aplicarFiltros = aplicarFiltros;
    window.irPrimeira = irPrimeira;
    window.irAnterior = irAnterior;
    window.irProxima  = irProxima;
    window.irUltima   = irUltima;
    window.mudarPageSize = mudarPageSize;

    // Boot
    (async function init(){
      await carregarTudo();
      aplicarFiltros();
    })();
  </script>
</body>
</html>
